<!DOCTYPE html>
<html>

<head>
    <title>Home</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/style.css') }}">
</head>

<body style="background-color: #ffffff;">
    <header style="background-color: #c2abab48;">
        <h1 class="text" style="color: blueviolet;">Reverse Image Search</h1>
    </header>
    <div class="container-atas">
        <a href = '/' style="text-decoration: none; color: inherit;" >
            <div class="container">
                <h3 class="text">HOME</h3>
            </div>
        </a>
        <a href = '/about' style="text-decoration: none; color: inherit;" >
            <div class="container">
                <h3 class="text">ABOUT</h3>
            </div>
        </a>
    </div>
    <div class="flex-container">
        <div class="flex-item-image">
            <img src="{{ image_url }}" alt="Uploaded Image"> 
        </div>
        <div class="flex-item-vert flex-container-vertical">
            <div class="flex-item">
                <h2 class="text">Upload Dataset (Image)</h2>
                
                <form method="POST" enctype="multipart/form-data" action="/use" class="search-button">
                    <input type="file" name="file">
                    <input type="submit" name = "action" value="Unggah">
                </form>
                <h2 class="text">Nama file : {{namafile}}</h2>
                <h3 class="text">{{ unggah }}</h3>
            </div>
            <div class="flex-container">
                <div class="flex-item toggle-container">
                    <div class="toggle-content-left">
                        <form action="/use" method="POST">
                            <button type="submit" class="search-button" name = "action" value="Search">SearchColor</button>
                            <button type="submit" class="search-button" name = "action" value="SearchTexture">SearchTexture</button>  
                        </form>
                    </div>
                </div>
                {% if result %}
                <div class="flex-item">
                    <form action="/use" method="POST">
                        <button type="submit" class="reset-button" name = "action" value="Reset">Reset</button>
                    </form>
                </div>
                {%endif%}
            </div>
            <div class="flex-item">
                <button id="kamera-button" class="search-button">Fitur Kamera</button>
                <button id="matikan-kamera" class="search-button">Matikan Kamera</button>

                
                <h1 id="timer" class="text"></h1>
                <script>
                    const kameraButton = document.getElementById("kamera-button");
                    const timerElement = document.getElementById("timer");
                    const matikanKameraButton = document.getElementById("matikan-kamera");

                    let captureInterval;
                    let secondsLeft = 5;

                    // Fungsi untuk menampilkan timer
                    function showTimer(seconds) {
                        timerElement.textContent = `Gambar akan diambil dalam ${seconds} detik`;
                    }

                    // Fungsi untuk menangani pengambilan gambar dan pengiriman ke server
                    function captureAndSendImage() {
    const canvas = document.createElement('canvas');
    const video = document.querySelector('video');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    // Set mode globalCompositeOperation untuk menghapus kanal alpha
    canvas.getContext('2d').globalCompositeOperation = 'copy';

    // Menggambar ulang ke elemen canvas
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    // Mengonversi elemen canvas ke blob dan mengirim ke server
    canvas.toBlob(async (blob) => {
        const formData = new FormData();
        newCapture = 'captured_image.jpg';
        formData.append('image', blob, newCapture);

        // Kirim gambar ke server menggunakan fetch
        await fetch('/use', {
            method: 'POST',
            body: formData,
        });
    }, 'image/jpeg');
}



                    // Fungsi untuk memulai kamera
                    function startCamera() {
                        timerElement.style.display = "block";
                        if (navigator.mediaDevices.getUserMedia) {
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(function (stream) {
                                    const videoElement = document.createElement("video");
                                    videoElement.srcObject = stream;
                                    videoElement.autoplay = true;
                                    kameraButton.parentElement.appendChild(videoElement);

                                    showTimer(secondsLeft);

                                    captureInterval = setInterval(function () {
                                        secondsLeft--;
                                        showTimer(secondsLeft);

                                        if (secondsLeft <= 0) {
                                            captureAndSendImage();
                                            showTimer(secondsLeft);
                                            clearInterval(captureInterval);
                                            setTimeout(() => {
                                                location.reload();
                                            }, 1000);
                                        }
                                    }, 1000);
                                })
                                .catch(function (error) {
                                    console.error("Gagal mengakses kamera: " + error);
                                });
                        } else {
                            alert("Peramban Anda tidak mendukung akses kamera.");
                        }
                    }

                    // Handler saat tombol "Kamera" ditekan
                    kameraButton.addEventListener("click", () => {
                        startCamera();
                        sessionStorage.setItem('kameraActive', 'true'); // Setel status kamera dalam sessionStorage
                    });

                    // Handler saat tombol "Matikan Kamera" ditekan
                    matikanKameraButton.addEventListener("click", () => {
                        const videoElements = document.querySelectorAll('video');
                        videoElements.forEach((videoElement) => {
                            const stream = videoElement.srcObject;
                            const tracks = stream.getTracks();
                            tracks.forEach((track) => {
                                track.stop();
                            });
                            videoElement.parentNode.removeChild(videoElement);
                        });

                        sessionStorage.setItem('kameraActive', 'false'); // Setel status kamera dalam sessionStorage menjadi tidak aktif
                        clearInterval(captureInterval);
                        timerElement.style.display = "none";
                    });

                    // Cek apakah kamera sebelumnya aktif saat halaman dimuat
                    const isCameraActive = sessionStorage.getItem('kameraActive') === 'true';
                    if (isCameraActive) {
                        startCamera(); // Kamera harus diaktifkan kembali jika sebelumnya aktif
                    }

                </script>


            </div>
            <div class="flex-container">
                <div class="flex-item">
                    <form action="/use" method="POST">
                        <button type="submit" class="search-button" name = "action" value="Scrap">Show Scrap</button>
                        <button type="submit" class="search-button" name = "action" value="stopScrape">Hide Scrap</button>
                        <button type="submit" class="search-button" name = "action" value="deleteScrap">Delete Database scrap</button>
                    </form>
                    <form action="/use" method="POST">
                        <label for="inputText">Masukkan link:</label>
                        <input type="text" id="inputText" name="inputLinkScrap">
                        <input type="submit" name = "action" value="SubmitLink">
                    </form>
                    <h2>Scrap view : {{isScrape}}</h2>
                </div>
            </div>
            {% if result%}
            <div class="flex-item">
                <h2 class="text">{{countfilter}} Result </h2>
                <h2 class="text">Waktu : {{ durasi }} detik</h2>
            </div>
            {% endif %}
        </div>
    </div>
    <hr style="border: 4px solid #ccc; margin: 20px 0;"> <!-- Menggunakan style untuk garis separator -->
    <div>
        <h2 class="text"> - Hover mouse ke gambar untuk informasi -</h2>
    </div>
    {% if result%}
    <div style="color: blueviolet; padding: 20px;" class="flex-item">
        <h2>--Searching {{namafile}} with {{searchType}} parameter -- </h2>
        <h2>Result: </h2>
    </div>
    {% endif %}
    {%if result%}
    <div class="grid-container-result">
        
        <div class="image-grid-result">
            {% for image in image_list %}
                <div class="image-item">
                    <div class="image-hover">
                        <img src="{{ image }}" alt="Image">
                        <div class="delete-button-container">
                            <form method="POST" action="/use">
                                <input type="hidden" name="image_path" value="{{ image }}">
                            </form>
                        </div>
                    </div>  
                    <h2 class="similarity-text">Similarity : {{ result[loop.index - 1][1] }}</h2>
                </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="grid-container">
        <div class="image-grid">
            {% for image in image_list %}
                <div class="image-item ">
                    <div class="image-hover ">
                        <img src="{{ image }}" alt="Image" class="fade-in">
                        <div class="delete-button-container">
                            <form method="POST" action="/use">
                                <input type="hidden" name="image_path" value="{{ image }}">
                                <button type="submit" class="delete-button" name="delete_image">Hapus</button>
                                <button type="submit" class="delete-button" name="select_image">Select</button>
                            </form>
                        </div>
                    </div>  
                    {% if result %}
                        <h2 class="similarity-text">Similarity : {{ result[loop.index - 1][1] }}</h2>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {%endif%}
    <div class="pagination">
        {% if current_page > 1 %}
            <a class="pagination-button" href="?page={{ current_page - 1 }}">Previous</a>
        {% endif %}
        <h2 style="color: blueviolet;">{{ current_page }}</h2>
        {% if current_page < num_pages %}
            <a class="pagination-button" href="?page={{ current_page + 1 }}">Next</a>
        {% endif %}
    </div>
    <div class="pagination">
        {% for page_num in range(1, num_pages + 1) %}
            <a class = "pagination-button"href="?page={{ page_num }}">{{ page_num }}</a>
        {% endfor %}
    </div>
 
    
    
      
    
</body>

</html>
